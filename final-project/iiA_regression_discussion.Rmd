---
title: "INFSCI 2595 Final"
subtitle: "Part iiA: Regression models (Discussion)"
author: "Ben Stein"
date: "4/13/2022"
output: html_document
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "knit") }
  )
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# About this document

In this document, I review the coefficient summaries from the top 3 regression models identified in the previous section and compare them to identify the most important inputs.

# Setup (libraries and tools)

## Libraries and tools

```{r}
library(tidyverse)

source("./tools.R")
```

## Models

```{r}
lm_model5 <- readr::read_rds("./models/lm_rank1_model5.rds")
lm_model4 <- readr::read_rds("./models/lm_rank2_model4.rds")
lm_model6 <- readr::read_rds("./models/lm_rank3_model6.rds")
```

# Coefficient summaries

```{r}
plot_lm_varimp <- function(model) {
  model %>%
    varImp %>%
    arrange(desc(Overall)) %>%
    head(15) %>%
    rownames_to_column() %>%
    rename(
      predictor = rowname,
      importance = Overall
    ) %>%
    ggplot(mapping = aes(x = importance, y = predictor)) +
    geom_col()
}
```


## Best-ranked model (model 5)

```{r}
plot_lm_varimp(lm_model5)
```

## Second-best ranked model (model 4)

```{r}
plot_lm_varimp(lm_model4)
```

## Third-best model ranked model (model 6)

```{r}
plot_lm_varimp(lm_model6)
```

# Discussion

## The importance of region and customer

Region only appears in one of these models (model 4), but it dominates other predictors by a lot. This makes me think region is a useful predictor. It's also interesting that while interactions between region and the sentiment features does matter, `region` by itself shows up twice in the top 15 features.

It's harder to make sense of the `customer` predictor in model 5. Unlike region, it doesn't seem important by itself, but does when interacted with some sentiment features. However, it's hard to tell how important it really is. For example, what's the median variable importance in this model?

```{r}
lm_model5 %>% 
  varImp %>%
  pull(Overall) %>%
  median
```

The fact that the median importance is much lower than the variables in the top 15 makes it clear that these variables matter, but I don't know how to make sense of the specific interactions we're observing.

## Sentiment predictors

Meanwhile, without knowing what the sentiment predictors really correspond to, it's hard to be sure how they matter. However, `xb_07` shows up in important variables in all three models (albeit as two interaction terms in model 6), so that seems significant.

# Visualizing common coefficients

I had a try at visualizing the common coefficients across models. However, this isn't totally accurate, because it considers interactions of, for example `xn_03` as distinct from `xn_03` as a solo predictor. I left it in because it was a lot of work.

```{r}
importance_to_df <- function(model, model_name) {
  varImp(model) %>%
    arrange(desc(Overall)) %>%
    mutate(model = model_name) %>%
    rownames_to_column() %>%
    rename(importance = Overall, predictor = rowname) %>%
    head(15)
}

df_importance <- rbind(
  importance_to_df(lm_model5, "model5"),
  importance_to_df(lm_model4, "model4"),
  importance_to_df(lm_model6, "model6")
)

df_importance %>%
  ggplot(mapping = aes(x = importance, y = predictor, fill = model)) + 
  geom_bar(stat="identity", position = position_dodge2(preserve = "single"))
```

